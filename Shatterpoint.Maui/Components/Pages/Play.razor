@using Shatterpoint.Lib.Services;
@using Shatterpoint.Lib.Units
@using Shatterpoint.Lib.Units.Abilities
@using Shatterpoint.Lib.Model;
@using Shatterpoint.Lib.Extensions;
@using Shatterpoint.Maui.Components.Reusable;

@page "/play"
@inject SelectedUnitsService SelectedUnitsService
@inject UnitDataBaseService UnitDataBaseService

@* Panel scrollable *@
<div class="scrollable">
    @* Case: List is empty *@
    @if (!@SelectedUnitsService.SelectedUnits.Any())
    {
        <p style="color: wheat; padding: 5px;">
            Select up to 6 units in the unit selection tab, then comme back here to enable the feature.
        </p>
    }
    @* Case: List is ready *@
    else
    {
        @* When a character is selected *@
        if (@SelectedUnitsService.ActiveUnit is not null)
        {
            /* Card: Unit active */
            <AbilityCard Unit="@SelectedUnitsService.ActiveUnit.ActiveUnit" Abilities="@SelectedUnitsService.ActiveUnit.CurrentActivationSynergies" IsActive="@true" />

            /* Card: Unit is targeted*/
            @if (@SelectedUnitsService.ActiveUnit.GettingTargetedSynegies.Any())
            {
                <AbilityCard Unit="@SelectedUnitsService.ActiveUnit.ActiveUnit" Abilities="@SelectedUnitsService.ActiveUnit.GettingTargetedSynegies" IsActive="@false" />
            }

            <ul style="color: wheat; ">
                <li style="padding: 5px; ">The 1st card shows all abilities usable for when the unit is doing something</li>
                <li style="padding: 5px; ">The 2nd card (if any) shows any ability for when the unit is the target of an attack.</li>
            </ul>
        }
        @* When "Pay attention" is selected *@
        else if (@SelectedUnitsService.PayAttentionAbilities is not null)
        {
            if (@SelectedUnitsService.PayAttentionAbilities.Any())
            {
                <AbilityCard Unit="null" Abilities="@SelectedUnitsService.PayAttentionAbilities" />
            }
            else
            {
                <p style="color: wheat; padding: 5px;">
                    The current list presents no ability to display at this timing.
                </p>
            }

            <p style="color: wheat; padding: 5px;">
                The "Pay attention" button will display all abilities that require your attention when your opponent is playing.
            </p>
        }
        @* Case: No selection *@
        else
        {
            <p style="color: wheat; padding: 5px;">
                Select a character to display available abilities.
            </p>
        }

        <p style="color: wheat; padding: 5px;">
            Tap the same selected character to display the original cards.
        </p>
    }


</div>

@* Fixed unit selection*@
<div class="selected-pp footer">

    @if (!@SelectedUnitsService.SelectedUnits.Any())
    {
        <p>There is no selected unit. Visit /build/index to select your 6 units</p>
    }
    else
    {
        @foreach (var unit in @SelectedUnitsService.SelectedUnits)
        {
            <a @onclick="() => SelectUnit(unit)">
                <ProfilePicture Scale="0.4" Top="@unit.Top" Left="@unit.Left" Src="@unit.StanceCardUrl1" Alt="@unit.Name" />
            </a>
        }
        <a @onclick="() => PayAttention()">
            <img style="width:40px; height:auto; border-radius:50%; outline: 2px solid black;" alt="Op turn" src="img/card/exclamation.jpg" />
        </a>
    }
</div>


@code {

    public void SelectUnit(Unit unit)
    {
        // Disable "pay attention" abilities
        SelectedUnitsService.PayAttentionAbilities = null;

        var activeAbilities = SelectedUnitsService.GetAbilitiesForTheActiveUnit(unit);
        var targetedAbilities = SelectedUnitsService.GetAbilitiesForTheTargetedUnit(unit);

        SelectedUnitsService.ActiveUnit = new ActiveUnitModel();
        SelectedUnitsService.ActiveUnit.ActiveUnit = unit;
        SelectedUnitsService.ActiveUnit.CurrentActivationSynergies = activeAbilities;
        SelectedUnitsService.ActiveUnit.GettingTargetedSynegies = targetedAbilities;

    }

    public void PayAttention()
    {
        // Disable active unit:
        SelectedUnitsService.ActiveUnit = null;

        var abilities = SelectedUnitsService.PayAttention();
        SelectedUnitsService.PayAttentionAbilities = abilities;
    }
}
